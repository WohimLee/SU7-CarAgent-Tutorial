## 意图设计
### 一、先想清楚：这个场景的意图要“分什么”

在车载场景里，你的意图分类建议不要按「NLP 教科书」那种太细的分类，而是直接对应你要调的子图 / Agent / 工具。

可以按这几个维度设计：

#### 顶层领域（domain） → 决定走哪个子图 / Agent

- manual（用户手册问答 / 说明书）
- vehicle（车况 / 控制）
- navigation（路线 / 目的地）
- trip（行程规划，跨多步骤）
- infotainment（音乐 / 电台 / 媒体）
- chitchat（闲聊 / 问答）
- system（关于助手自己的指令）

#### 动作类型（action_type） → 决定调用工具还是查知识

- query（问问题 / 查信息，典型走 RAG）
- control（执行操作，下发车机指令）
- plan（多步骤规划）
- feedback（确认 / 否认 / 修改）

#### 目标对象（target） → 车辆组件 / 手册模块等

- 空调、车窗、座椅、车灯、驾驶模式、告警灯、导航目的地、音源…

#### 安全 & 驾驶相关标记（safety_tag）（可选）

- driving_sensitive（行驶中不宜复杂操作）
- safety_critical（涉及安全系统）
- Orchestrator 只要根据这些维度产出结构化意图，LangGraph 就好路由了。

### 二、推荐的一套“车载助手”意图分类表

下面这套可以直接用作初版，后续你可以根据日志迭代。

#### 1）手册 / 说明书相关（manual）

- manual_feature_usage: “怎么用自适应巡航？”
- manual_warning_indicator: “黄色发动机灯亮了什么意思？”
- manual_troubleshooting: “窗户关不上了怎么办？”
- manual_spec_parameter: “这辆车轮胎胎压标准是多少？”
- manual_system_explanation: “节能模式和普通模式有什么区别？”

这些全部走 Manual RAG 子图，动作类型基本是 query。

#### 2）车辆状态 / 控制（vehicle）
- vehicle_status_query: “现在还有多少电？”; “车门有没有关好？”
- vehicle_control_ac: “把空调调到 22 度”; “开大一点风”
- vehicle_control_window: “把驾驶位车窗降一点”
- vehicle_control_light: “打开近光灯”
- vehicle_control_seat: “帮我加热座椅”
- vehicle_control_drive_mode: “切到运动模式”
- vehicle_control_misc（其他控制）: 雨刮、天窗、尾门等。

这些意图全部走 Vehicle Control 子图，动作类型基本是 control，状态类是 query。

#### 3）导航 / 路线（navigation）

- navigation_set_destination: “导航到最近的充电站”; “带我去公司”
- navigation_add_stop: “顺路帮我找个便利店”
- navigation_cancel: “取消导航”
- navigation_poi_search: “附近有什么好吃的火锅？”
- navigation_route_preference: “不要走高速”; “选一条不堵车的路”

这些大多走 Navigation 子图，动作 control + query 混合（既查又设）。

#### 4）行程 / 综合任务（trip）

- trip_plan_route_plus_vehicle: “明天去杭州旅游，帮我规划路线，还要看看电够不够。”
- trip_check_before_drive: “我要出长途，帮我检查一下车况，需要注意什么？”
- trip_charging_plan: “从上海到南京，帮我规划一下充电站。”

这些意图适合丢给 Task Planner 子图，由 Planner 再调用其他子图（manual / vehicle / navigation）。

#### 5）娱乐 / 媒体（infotainment）

- media_play_music: “放点轻音乐”
- media_play_radio: “打开 FM 87.6”
- media_play_source: “放我手机里的歌”
- media_control: “暂停一下”; “下一首”

这些走 媒体/娱乐 Agent 或子图（如果你要做的话）。

#### 6）闲聊 & QA（chitchat）

- chitchat_general: “讲个笑话”; “你是谁？”
- chitchat_qa（和车无关的问答）: “今天是几号？”; “什么是黑洞？”

这些走一个简单的 闲聊 Agent 或直接调用 LLM，不进入车辆控制和 RAG。

#### 7）系统 / 元指令（system）

- system_help: “你能帮我做什么？”
- system_settings: “说话声音小一点。” （调整 TTS 音量）
- system_mode_switch: “切换成简洁模式回答。”

配一个轻量的 System Agent 即可。

### 三、让 Orchestrator 输出什么样的“意图结构”

推荐你用一个统一的结构，方便 LangGraph 用 conditional_edges 分流：
```py
{
  "intent": "vehicle_control_ac",
  "domain": "vehicle",
  "action_type": "control",
  "target": "ac",
  "slots": {
    "temperature": 22,
    "fan_level": null
  },
  "need_clarification": false,
  "confidence": 0.86
}
```

对比几个例子：

>示例 1：手册问答

“这个黄色发动机故障灯亮了是什么意思？”
```py
{
  "intent": "manual_warning_indicator",
  "domain": "manual",
  "action_type": "query",
  "target": "engine_warning_light",
  "slots": {
    "color": "yellow"
  },
  "need_clarification": false,
  "confidence": 0.92
}
```

→ Orchestrator 根据 domain == "manual" 路由到 manual_rag_subgraph。

>示例 2：直接控制车辆

“把空调调到二十二度。”
```py
{
  "intent": "vehicle_control_ac",
  "domain": "vehicle",
  "action_type": "control",
  "target": "ac",
  "slots": {
    "temperature": 22,
    "mode": null
  },
  "need_clarification": false,
  "confidence": 0.95
}
```

→ 走 vehicle_control_subgraph，子图内部调用 set_ac_temperature(22) 工具。

>示例 3：模糊表达，需要澄清

“空调要冷一点。”
```py
{
  "intent": "vehicle_control_ac",
  "domain": "vehicle",
  "action_type": "control",
  "target": "ac",
  "slots": {
    "temperature_delta": -2
  },
  "need_clarification": true,
  "confidence": 0.78
}
```

→ Orchestrator 或 Vehicle 子图看到 need_clarification == true，先走“澄清节点”：

“我可以帮你把温度下调 2 度，可以吗？”

### 四、在 LangGraph 里使用这些意图

顶层 Orchestrator 节点（一个 LLM 调用）输出上面的 JSON，然后：

- domain 用来做一级路由：
    - manual → manual_rag_graph
    - vehicle → vehicle_control_graph
    - navigation → navigation_graph
    - trip → task_planner_graph
    - infotainment → media_graph
    - chitchat → chitchat_graph
- intent 在子图内部用于二级分支：
    - vehicle_control_graph 里：
        - vehicle_control_ac → 调 AC 工具
        - vehicle_control_window → 调窗户工具
- slots 直接作为子图/工具的输入
- need_clarification 决定是否先走“Clarification Node”

伪逻辑示意（自然语言版）：

- Orchestrator 节点：
    - 输入：state.history 中最新一轮用户说话
    - 输出：state.intent / state.domain / state.slots / state.need_clarification
- add_conditional_edges("orchestrator", ...) 按 state.domain 跳到不同子图
- 子图里再按 state.intent/state.slots 决定调用哪些工具。

### 五、几个常见坑 & 建议

##### 1. 不要一上来设计几十个意图

先覆盖 80% 场景：

manual_* 3–4 个

vehicle_status_query / vehicle_control_ac / vehicle_control_window / vehicle_control_light

navigation_set_destination / navigation_poi_search

日志跑一段时间，再细分。

##### 2. “问用法” vs “直接控制” 要有原则

“怎么开空调？” → manual_feature_usage（RAG）

“帮我开空调。” → vehicle_control_ac（控制）

关键词 + 句式可以强约束：带“怎么、如何、什么意思”优先当 manual。

##### 3. 允许多标签 / 非确定性（可选）

给 JSON 里加一个 alt_intents 列表，存可能性较高的第二候选，让后续模块做 fallback。

##### 4. 意图命名统一风格

用 snake_case 英文，后面写代码、埋点、分析日志都方便。

##### 5. 安全相关单独打标签
比如检测到“关闭安全气囊”、“解除限速”之类 → safety_tag="safety_critical"，统一走 safety_agent 做强拒绝。